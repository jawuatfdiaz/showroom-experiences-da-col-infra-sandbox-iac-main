Terraform_template
==================

The principal goal of this role is to create the base line of the IaC, all about `Terraform`, `Pulumi` and so on, in order to have the infraestructure base. The idea for the `template users` is that their can put the `tf files` into the files folder for example, or all files that can be shared to the requester users to have the base line of the infraestructure. we put a resource group as example.

```hcl
resource "azurerm_resource_group" "rg_main" {
  provider = azurerm.resources
  name     = substr("RSGRMAIN-${var.name}", 0, 90)
  location = var.location
  tags     = var.tags
  lifecycle {
    ignore_changes = [name]
  }
}
```
The idea of the base infraestructure is that can be idempotent and replicated, in order to do that, try to use names with timestamps, or unique identifiers and try to do the necessary tests to sure that the infra can be deployed multiple times.
```hcl
resource "random_string" "name" {
  length  = 6
  special = false
}
locals {
  timestamp_full  = formatdate("YYYY-MMMM-DD-HH-mm-ss", timestamp())
  timestamp_short = formatdate("HHmm", timestamp())
}
```
Finally, in the templates folder of this role, we try to put the non static files, for example the backend config of `terraform` in order to use the poc id (from the portal and micros) as id of the `tfstate` or for example to replace the values of the tags in the variables of `terraform` to identify the deployed resources.


```jinja
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=3.43.0"
    }
  }
  backend "azurerm" {
    resource_group_name  = "TFSTATE"
    storage_account_name = "iacgralstatepocdeployer"
    container_name       = "iacgralstate"
    key                  = "{{ DEPLOY_ID }}.terraform.tfstate"
  }
}
provider "azurerm" {
  features {}
  alias           = "resources"
  subscription_id = "{{ SANDBOX_ARM_SUBSCRIPTION_ID }}"
}
```

```jinja 
variable "tags" {
  description = "Tags for the resource group"
  type        = map(string)
  default     = {
    costCenter   = "{{ COST_CENTER }}"
    ownerPoc     = "{{ OWNER_POC }}"
    ownerDeploy  = "{{ OWNER_DEPLOY }}"
    pocId        = "{{ POC_ID }}"
    deployId     = "{{ DEPLOY_ID }}"
  }
}

variable "name" {
  description = "Name for infraestructure"
  type        = string
  default     = "{{ github_short_composed_repo_name }}-{{ DEPLOY_ID }}"
}

variable "location" {
  description = "Name for infraestructure"
  type        = string
  default     = "Central US"
}
```

This role creates a `.tf` file, edits the file with the Azure resource provider, and copies the IaC to the cloned repository. This allows you to log in to the portal with `az login` and then obtain the subscription you will be working with. For this role to work correctly, you need to provide the required environment variables before requesting the Proof of Concept (POC) from the sandbox portal. For example:

-   `COST_CENTER`: cost center used to tag the deploy resources provided by the showroom experiences microservices, getted from the web portal in a demo requested
-   `OWNER_DEPLOY`: id of the requester demo user used to tag the deploy resources provided by the showroom experiences microservices, getted from the web portal in a demo requested
-   `OWNER_POC`: id of the requested poc used to tag the deploy resources provided by the showroom experiences microservices, getted from the web portal in a demo requested
-   `POC_ID`: id of the requested poc used to tag the deploy resources provided by the showroom experiences microservices, getted from the web portal in a demo requested
-   `DEPLOY_ID`: id of the requested demo used to tag the deploy resources provided by the showroom experiences microservices, getted from the web portal in a demo requested
-   `URL_GITHUB_DESTINATION_REPO`: This is the URL of github repository to clone and put here the IaC generated by the template
-   `CURRENT_INFRAESTRUCTURE_NAME`: This is the base name of the POC, is used as name of the resource groups or to tag the infra.
-   `GITHUB_USERNAME`: Own github username to use as authentication to github
-   `GITHUB_TOKEN`: Own github token to use as authentication to github 
-   `SANDBOX_ARM_SUBSCRIPTION_ID` Subscription id to use as authentication of az cli

If you wish to add more functionalities or implement your architecture, you can start creating tasks after the "Commit files" task.

TASKS
-----

### Check Variables and Values

Verifies if all the required variables are defined and not empty. If any variable is undefined or empty, the task will fail with an error message. This ensures that the required variables are configured before proceeding with the deployment.

### Create `variables.tf` File

This task automates the creation of the Terraform configuration file named `variables.tf` using a template `variables.tf.j2`. The resulting file will be generated in the `azure-tf` folder within the directory.

### Set `subscriptionId`

This task sets the `azureSubscriptionID` variable using the value of the `ARM_SUBSCRIPTION_ID` environment variable.

### Create `provider.tf` File

Using a `provider.tf.j2` template, this task creates the `provider.tf` file, specifying the Azure resource provider for Terraform.

### Set New Variable with Username and Password

This task sets the `authenticated_repository_url` variable, which contains the URL of the GitHub repository. This URL is formed using the GitHub username and access token to authenticate the repository cloning.

### Clone Git Repository

The authenticated Git repository is cloned from the URL generated in the previous task. The repository is cloned into the `github_repository` folder within the directory.

### Create Branch

Creates a new `main` branch in the cloned repository. The branch is set as the active branch for committing operations.

### Copy Files to Cloned Repository

Files from the `azure-tf` folder in the directory are copied to the cloned repository folder. This ensures that Terraform configuration files are available in the local repository.

### Commit Files

Finally, this task prepares, commits, and pushes the files to the remote repository. Git user information is configured, and a commit is made with a message. The changes are pushed to the `main` branch of the repository.

Example tasks for `terraform_template`
--------------------------------------

```yml
- name: Create variables.tf file
  template:
    src: "templates/variables.tf.j2"
    dest: "{{ playbook_dir }}/roles/terraform_template/files/azure-tf/variables.tf"
    force: true
```

Important Notes
---------------

-   Ensure that you correctly configure the variables for GitHub authentication.
-   These tasks are designed to enhance automation and collaboration in infrastructure development.
-   Run the playbook using the command: `ansible-playbook playbook.yml`.

License
-------

BSD

Author Information
------------------

@NTTDATA | Digital Technology | Digital Architecture